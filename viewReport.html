<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IMS Monitor ‚Äî Detailed Report</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="style.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
                    colors: { 'navy': '#0f172a', 'primary': '#3b82f6' }
                }
            }
        }
    </script>
    <style>
        body { background: #f1f5f9; font-family: 'Inter', sans-serif; }
        /* Custom Scrollbar */
        .table-container::-webkit-scrollbar { width: 8px; height: 8px; }
        .table-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        /* Sticky Header */
        thead th { position: sticky; top: 0; background: #f8fafc; z-index: 10; }
    </style>
</head>

<body class="text-slate-700">

    <nav class="nav">
        <div class="nav-inner">
            <div class="brand">
                <span class="brand-text">IMS Tank Monitor</span>
            </div>
            <div class="nav-links">
                <a href="index.html" class="nav-btn">Operation (Live)</a>
                <a href="dashboard.html" class="nav-btn">Dashboard</a>
                <a href="viewReport.html" class="nav-btn active">View Report</a>
                <a href="manage-photo.html" class="nav-btn">Photos (Admin)</a>
                <div class="user-profile" onclick="location.href='index.html'" style="cursor: pointer;">
                    Home üè†
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto mt-[40px] mb-16 px-4 sm:px-6 lg:px-8">

        <div class="flex flex-col md:flex-row justify-between items-end mb-6 gap-4">
            <div>
                <h1 class="text-2xl font-bold text-slate-800">Logbook Report</h1>
                <p class="text-sm text-slate-500">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Cloud Database)</p>
            </div>
            <button onclick="exportToCSV()" class="bg-green-600 text-white px-5 py-2 rounded-lg shadow hover:bg-green-700 transition flex items-center gap-2 font-semibold text-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
                Export CSV
            </button>
        </div>

        <section class="bg-white p-4 rounded-lg shadow-sm border border-slate-200 mb-6">
            <div class="flex flex-wrap items-center gap-3">
                
                <div class="flex items-center space-x-2 border border-slate-300 px-3 py-1.5 rounded-md bg-slate-50">
                    <span class="text-xs font-bold text-slate-500 uppercase">Date:</span>
                    <input type="date" id="filterDate" class="bg-transparent text-sm outline-none text-slate-700">
                </div>

                <div class="flex items-center space-x-2 border border-slate-300 px-3 py-1.5 rounded-md bg-white">
                    <span class="text-xs font-bold text-slate-500 uppercase">Line:</span>
                    <select id="filterLine" class="bg-transparent text-sm outline-none text-slate-700 cursor-pointer">
                        <option value="all">All Lines</option>
                        <option value="Ex.1">Ex.1</option>
                        <option value="Ex.2">Ex.2</option>
                        <option value="Ex.3">Ex.3</option>
                        <option value="Ex.4">Ex.4</option>
                        <option value="Ex.5">Ex.5</option>
                    </select>
                </div>

                <div class="flex items-center space-x-2 border border-slate-300 px-3 py-1.5 rounded-md bg-white">
                    <span class="text-xs font-bold text-slate-500 uppercase">Status:</span>
                    <select id="filterStatus" class="bg-transparent text-sm outline-none text-slate-700 cursor-pointer">
                        <option value="all">All Status</option>
                        <option value="new">New</option>
                        <option value="ack">In Progress</option>
                        <option value="done">Closed</option>
                    </select>
                </div>

                <div class="ml-auto flex gap-2">
                    <button onclick="applyFilters()" class="bg-navy text-white px-4 py-1.5 rounded-md text-sm font-semibold hover:bg-slate-700 transition shadow-sm">
                        Search
                    </button>
                    <button onclick="resetFilters()" class="text-slate-500 text-sm hover:text-navy underline px-2">
                        Reset
                    </button>
                </div>
            </div>
        </section>

        <section class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden flex flex-col" style="max-height: 600px;">
            <div class="overflow-auto table-container flex-1">
                <table class="min-w-full divide-y divide-slate-200 text-sm">
                    <thead class="bg-slate-50">
                        <tr>
                            <th class="px-6 py-3 text-left font-bold text-slate-500 uppercase tracking-wider w-32">Date/Time</th>
                            <th class="px-6 py-3 text-left font-bold text-slate-500 uppercase tracking-wider w-24">Line</th>
                            <th class="px-6 py-3 text-left font-bold text-slate-500 uppercase tracking-wider">Extruder Info</th>
                            <th class="px-6 py-3 text-left font-bold text-slate-500 uppercase tracking-wider">Issue (Blending)</th>
                            <th class="px-6 py-3 text-left font-bold text-slate-500 uppercase tracking-wider w-32">Downtime</th>
                            <th class="px-6 py-3 text-left font-bold text-slate-500 uppercase tracking-wider w-32">Status</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="bg-white divide-y divide-slate-100 text-slate-600">
                        <tr><td colspan="6" class="text-center py-10 text-slate-400">Loading data...</td></tr>
                    </tbody>
                </table>
            </div>
            
            <div class="px-6 py-3 bg-slate-50 border-t border-slate-200 text-xs text-slate-500 flex justify-between items-center">
                <span id="totalRows" class="font-semibold">Total: 0 records</span>
                <span>Last update: <span id="lastUpdate">Now</span></span>
            </div>
        </section>

    </main>

    <script>
        // --- CONFIGURATION ---
        const SUPABASE_URL = 'https://xsnxtkukxorjxogirrrx.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhzbnh0a3VreG9yanhvZ2lycnJ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNDc3NzIsImV4cCI6MjA3OTcyMzc3Mn0.tuiYQtbwrU8GE2OzeZT4PhB9TKgFzBSHS1XbaNknvGM';
        
        const { createClient } = supabase;
        const sb = createClient(SUPABASE_URL, SUPABASE_KEY);

        let allData = [];

        document.addEventListener('DOMContentLoaded', async () => {
            await loadData();
            
            // Default: Today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('filterDate').value = today;
            
            applyFilters();
        });

        // 1. LOAD DATA
        async function loadData() {
            const { data, error } = await sb
                .from('ims_cases')
                .select('*')
                .order('created_at', { ascending: false })
                .limit(2000); // ‡πÄ‡∏û‡∏¥‡πà‡∏° Limit ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏¢‡∏≠‡∏∞‡πÜ

            if (error) {
                console.error("Error:", error);
                document.getElementById('tableBody').innerHTML = '<tr><td colspan="6" class="text-center py-8 text-red-500">Error loading data</td></tr>';
                return;
            }
            
            allData = data.map(c => {
                const start = new Date(c.created_at);
                const end = c.resolve_time ? new Date(c.resolve_time) : new Date();
                const duration = Math.ceil((end - start) / 60000);
                if (duration < 0) duration = 0;

                return {
                    id: c.id,
                    startTime: start,
                    resolveTime: c.resolve_time ? new Date(c.resolve_time) : null,
                    line: c.line,
                    reporter: c.reporter,
                    recipe: c.recipe,
                    plan: c.plan_tons,
                    status: c.status,
                    ackReason: c.ack_reason || '-',
                    resBy: c.resolve_by || '-',
                    resTank: c.resolve_tank || '-',
                    duration: duration
                };
            });
        }

        // 2. FILTER & RENDER
        function applyFilters() {
            const fDate = document.getElementById('filterDate').value;
            const fLine = document.getElementById('filterLine').value;
            const fStatus = document.getElementById('filterStatus').value;

            const filtered = allData.filter(c => {
                const cDateStr = c.startTime.toISOString().split('T')[0];
                const matchDate = !fDate || cDateStr === fDate;
                const matchLine = fLine === 'all' || c.line === fLine;
                const matchStatus = fStatus === 'all' || c.status === fStatus;
                return matchDate && matchLine && matchStatus;
            });

            renderTable(filtered);
        }

        function resetFilters() {
            document.getElementById('filterDate').value = '';
            document.getElementById('filterLine').value = 'all';
            document.getElementById('filterStatus').value = 'all';
            applyFilters();
        }

        function renderTable(data) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-12 text-slate-400 italic">No records found</td></tr>';
                document.getElementById('totalRows').innerText = `Total: 0 records`;
                return;
            }

            data.forEach(c => {
                // Status Badge Style
                let badgeClass = c.status === 'done' ? 'bg-green-100 text-green-700' : (c.status === 'ack' ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700');
                let badgeText = c.status === 'done' ? 'CLOSED' : (c.status === 'ack' ? 'IN PROGRESS' : 'NEW');

                // Duration Style
                let durClass = c.duration > 60 ? 'text-red-600 font-bold' : 'text-slate-700 font-medium';

                // Blending Info
                let blendInfo = '<span class="text-slate-300">-</span>';
                if(c.status !== 'new') {
                    blendInfo = `<div class="font-semibold text-slate-700">${c.ackReason}</div>`;
                    if(c.status === 'done') {
                        blendInfo += `<div class="text-xs text-slate-400 mt-1">Tank: ${c.resTank} | By: ${c.resBy}</div>`;
                    }
                }

                const row = `
                    <tr class="hover:bg-slate-50 border-b border-slate-100 transition group">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-slate-800 font-medium">${c.startTime.toLocaleDateString('th-TH')}</div>
                            <div class="text-xs text-slate-400 font-mono">${c.startTime.toLocaleTimeString('th-TH')}</div>
                        </td>
                        <td class="px-6 py-4 font-bold text-navy">${c.line}</td>
                        <td class="px-6 py-4">
                            <div class="font-semibold text-slate-700">${c.recipe}</div>
                            <div class="text-xs text-slate-400 mt-0.5">Plan: ${c.plan} T | By: ${c.reporter}</div>
                        </td>
                        <td class="px-6 py-4">${blendInfo}</td>
                        <td class="px-6 py-4 font-mono ${durClass}">${c.duration} m</td>
                        <td class="px-6 py-4">
                            <span class="px-2.5 py-1 rounded text-[10px] font-bold tracking-wide uppercase ${badgeClass}">${badgeText}</span>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });

            document.getElementById('totalRows').innerText = `Total: ${data.length} records`;
            document.getElementById('lastUpdate').innerText = new Date().toLocaleTimeString();
        }

        // 3. EXPORT CSV
        function exportToCSV() {
            if (allData.length === 0) { alert("No data to export"); return; }

            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Date,Time,Line,Recipe,Plan(Tons),Reporter,Status,Reason,Downtime(Min),ResolveBy,TankID\n";

            allData.forEach(c => {
                const dateStr = c.startTime.toLocaleDateString('th-TH');
                const timeStr = c.startTime.toLocaleTimeString('th-TH');
                const cleanReason = c.ackReason.replace(/,/g, " "); // ‡∏Å‡∏±‡∏ô CSV ‡∏û‡∏±‡∏á
                
                const row = [
                    dateStr, timeStr, c.line, c.recipe, c.plan, c.reporter, 
                    c.status, cleanReason, c.duration, c.resBy, c.resTank
                ].join(",");
                csvContent += row + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "IMS_Logbook_" + new Date().toISOString().slice(0,10) + ".csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>